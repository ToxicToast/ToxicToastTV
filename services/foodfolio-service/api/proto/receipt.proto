syntax = "proto3";

package foodfolio.v1;

option go_package = "toxictoast/services/foodfolio-service/api/proto/foodfolio/v1;foodfoliov1";

import "common.proto";
import "google/protobuf/timestamp.proto";
import "warehouse.proto";
import "item_variant.proto";

// ReceiptItem message
message ReceiptItem {
  string id = 1;
  string receipt_id = 2;
  optional string item_variant_id = 3;    // Matched variant (nullable)
  string item_name = 4;                   // Name from receipt
  int32 quantity = 5;
  double unit_price = 6;
  double total_price = 7;
  optional string article_number = 8;     // From receipt
  bool is_matched = 9;                    // Successfully matched
  Timestamps timestamps = 10;

  // Optional relations
  optional ItemVariant item_variant = 11;
}

// Receipt message
message Receipt {
  string id = 1;
  string warehouse_id = 2;                    // Where purchased
  google.protobuf.Timestamp scan_date = 3;
  double total_price = 4;
  optional string image_path = 5;             // Path to scanned image
  optional string ocr_text = 6;               // Raw OCR output
  Timestamps timestamps = 7;

  // Optional relations
  optional Warehouse warehouse = 8;
  repeated ReceiptItem items = 9;
  int32 total_items = 10;
  int32 matched_items = 11;
  int32 unmatched_items = 12;
}

// Upload receipt request
message UploadReceiptRequest {
  string warehouse_id = 1;
  bytes image_data = 2;                       // Image file data
  string content_type = 3;                    // "image/jpeg", "image/png", "application/pdf"
}

// Upload receipt response
message UploadReceiptResponse {
  Receipt receipt = 1;
  string upload_id = 2;                       // For tracking processing status
}

// Process receipt request
message ProcessReceiptRequest {
  string receipt_id = 1;
  bool auto_match = 2;                        // Automatically match items
}

// Process receipt response
message ProcessReceiptResponse {
  Receipt receipt = 1;
  string ocr_text = 2;
  repeated ReceiptItem items = 3;
  int32 matched_count = 4;
  int32 unmatched_count = 5;
}

// Create receipt request (manual)
message CreateReceiptRequest {
  string warehouse_id = 1;
  google.protobuf.Timestamp scan_date = 2;
  double total_price = 3;
}

// Create receipt response
message CreateReceiptResponse {
  Receipt receipt = 1;
}

// Get receipt response
message GetReceiptResponse {
  Receipt receipt = 1;
}

// List receipts request
message ListReceiptsRequest {
  optional string warehouse_id = 1;           // Filter by warehouse
  optional google.protobuf.Timestamp start_date = 2;
  optional google.protobuf.Timestamp end_date = 3;
  PaginationRequest pagination = 4;
  DeletedFilter deleted_filter = 5;
}

// List receipts response
message ListReceiptsResponse {
  repeated Receipt receipts = 1;
  PaginationResponse pagination = 2;
  double total_amount = 3;                    // Sum of all receipts
}

// Update receipt request
message UpdateReceiptRequest {
  string id = 1;
  optional string warehouse_id = 2;
  optional google.protobuf.Timestamp scan_date = 3;
  optional double total_price = 4;
}

// Update receipt response
message UpdateReceiptResponse {
  Receipt receipt = 1;
}

// Add item to receipt request
message AddItemToReceiptRequest {
  string receipt_id = 1;
  string item_name = 2;
  int32 quantity = 3;
  double unit_price = 4;
  optional string article_number = 5;
  optional string item_variant_id = 6;        // If already matched
}

// Add item to receipt response
message AddItemToReceiptResponse {
  ReceiptItem item = 1;
}

// Update receipt item request
message UpdateReceiptItemRequest {
  string id = 1;
  optional string item_name = 2;
  optional int32 quantity = 3;
  optional double unit_price = 4;
  optional string article_number = 5;
}

// Update receipt item response
message UpdateReceiptItemResponse {
  ReceiptItem item = 1;
}

// Match receipt item request
message MatchReceiptItemRequest {
  string receipt_item_id = 1;
  string item_variant_id = 2;
}

// Match receipt item response
message MatchReceiptItemResponse {
  ReceiptItem item = 1;
}

// Auto-match receipt items request
message AutoMatchReceiptItemsRequest {
  string receipt_id = 1;
  double similarity_threshold = 2;            // 0.0-1.0, default 0.8
}

// Auto-match receipt items response
message AutoMatchReceiptItemsResponse {
  int32 matched_count = 1;
  int32 unmatched_count = 2;
  repeated ReceiptItem matched_items = 3;
  repeated ReceiptItem unmatched_items = 4;
}

// Create inventory from receipt request
message CreateInventoryFromReceiptRequest {
  string receipt_id = 1;
  string location_id = 2;                     // Where to store items
  optional google.protobuf.Timestamp expiry_date = 3; // Default expiry for all items
  bool only_matched = 4;                      // Only create for matched items
}

// Create inventory from receipt response
message CreateInventoryFromReceiptResponse {
  int32 created_count = 1;
  repeated string item_detail_ids = 2;
}

// Get receipt statistics request
message GetReceiptStatisticsRequest {
  optional string warehouse_id = 1;
  optional google.protobuf.Timestamp start_date = 2;
  optional google.protobuf.Timestamp end_date = 3;
}

// Get receipt statistics response
message GetReceiptStatisticsResponse {
  int32 total_receipts = 1;
  double total_amount = 2;
  double average_amount = 3;
  int32 total_items = 4;
  double average_items_per_receipt = 5;
  map<string, int32> items_by_warehouse = 6;  // Warehouse ID -> count
}

// Receipt service
service ReceiptService {
  rpc UploadReceipt(UploadReceiptRequest) returns (UploadReceiptResponse);
  rpc ProcessReceipt(ProcessReceiptRequest) returns (ProcessReceiptResponse);
  rpc CreateReceipt(CreateReceiptRequest) returns (CreateReceiptResponse);
  rpc GetReceipt(IdRequest) returns (GetReceiptResponse);
  rpc ListReceipts(ListReceiptsRequest) returns (ListReceiptsResponse);
  rpc UpdateReceipt(UpdateReceiptRequest) returns (UpdateReceiptResponse);
  rpc DeleteReceipt(IdRequest) returns (SuccessResponse);

  // Item management
  rpc AddItemToReceipt(AddItemToReceiptRequest) returns (AddItemToReceiptResponse);
  rpc UpdateReceiptItem(UpdateReceiptItemRequest) returns (UpdateReceiptItemResponse);

  // Matching
  rpc MatchReceiptItem(MatchReceiptItemRequest) returns (MatchReceiptItemResponse);
  rpc AutoMatchReceiptItems(AutoMatchReceiptItemsRequest) returns (AutoMatchReceiptItemsResponse);

  // Inventory creation
  rpc CreateInventoryFromReceipt(CreateInventoryFromReceiptRequest) returns (CreateInventoryFromReceiptResponse);

  // Statistics
  rpc GetReceiptStatistics(GetReceiptStatisticsRequest) returns (GetReceiptStatisticsResponse);
}
