syntax = "proto3";

package foodfolio.v1;

option go_package = "toxictoast/services/foodfolio-service/api/proto/foodfolio/v1;foodfoliov1";

import "common.proto";
import "google/protobuf/timestamp.proto";
import "item_variant.proto";
import "warehouse.proto";
import "location.proto";

// ItemDetail (Physical Item) message
message ItemDetail {
  string id = 1;
  string item_variant_id = 2;
  string warehouse_id = 3;                        // Where purchased
  string location_id = 4;                         // Where stored
  optional string article_number = 5;             // Store's product number
  double purchase_price = 6;                      // Actual price paid
  google.protobuf.Timestamp purchase_date = 7;
  optional google.protobuf.Timestamp expiry_date = 8; // MHD
  optional google.protobuf.Timestamp opened_date = 9;
  bool is_opened = 10;
  bool has_deposit = 11;                          // Pfand
  bool is_frozen = 12;                            // Currently frozen
  Timestamps timestamps = 13;

  // Optional relations
  optional ItemVariant item_variant = 14;
  optional Warehouse warehouse = 15;
  optional Location location = 16;

  // Calculated fields
  bool is_expired = 17;      // Past expiry date
  bool is_expiring_soon = 18; // Expiring within configured days
  bool is_consumed = 19;     // Opened and expired
}

// Create item detail request
message CreateItemDetailRequest {
  string item_variant_id = 1;
  string warehouse_id = 2;
  string location_id = 3;
  optional string article_number = 4;
  double purchase_price = 5;
  google.protobuf.Timestamp purchase_date = 6;
  optional google.protobuf.Timestamp expiry_date = 7;
  bool has_deposit = 8;
  bool is_frozen = 9;
}

// Create item detail response
message CreateItemDetailResponse {
  ItemDetail item_detail = 1;
}

// Batch create item details request (for bulk purchases)
message BatchCreateItemDetailsRequest {
  string item_variant_id = 1;
  string warehouse_id = 2;
  string location_id = 3;
  optional string article_number = 4;
  double purchase_price = 5;
  google.protobuf.Timestamp purchase_date = 6;
  optional google.protobuf.Timestamp expiry_date = 7;
  bool has_deposit = 8;
  bool is_frozen = 9;
  int32 quantity = 10; // Number of items to create
}

// Batch create item details response
message BatchCreateItemDetailsResponse {
  repeated ItemDetail item_details = 1;
  int32 created_count = 2;
}

// Get item detail response
message GetItemDetailResponse {
  ItemDetail item_detail = 1;
}

// List item details request
message ListItemDetailsRequest {
  optional string item_variant_id = 1;  // Filter by variant
  optional string warehouse_id = 2;     // Filter by warehouse
  optional string location_id = 3;      // Filter by location
  optional bool is_opened = 4;          // Filter opened/unopened
  optional bool has_deposit = 5;        // Filter items with deposit
  optional bool is_frozen = 6;          // Filter frozen items
  PaginationRequest pagination = 7;
  DeletedFilter deleted_filter = 8;
}

// List item details response
message ListItemDetailsResponse {
  repeated ItemDetail item_details = 1;
  PaginationResponse pagination = 2;
}

// Update item detail request
message UpdateItemDetailRequest {
  string id = 1;
  optional string location_id = 2;      // Move to different location
  optional string article_number = 3;
  optional double purchase_price = 4;
  optional google.protobuf.Timestamp expiry_date = 5;
  optional bool has_deposit = 6;
  optional bool is_frozen = 7;
}

// Update item detail response
message UpdateItemDetailResponse {
  ItemDetail item_detail = 1;
}

// Open item request
message OpenItemRequest {
  string id = 1;
}

// Open item response
message OpenItemResponse {
  ItemDetail item_detail = 1;
  google.protobuf.Timestamp opened_date = 2;
}

// Move items request (change location for multiple items)
message MoveItemsRequest {
  repeated string item_detail_ids = 1;
  string new_location_id = 2;
}

// Move items response
message MoveItemsResponse {
  repeated ItemDetail item_details = 1;
  int32 moved_count = 2;
}

// Get expiring items request
message GetExpiringItemsRequest {
  int32 days = 1; // Items expiring within N days
  PaginationRequest pagination = 2;
}

// Get expiring items response
message GetExpiringItemsResponse {
  repeated ItemDetail item_details = 1;
  PaginationResponse pagination = 2;
  int32 total_expiring = 3;
}

// Get expired items request
message GetExpiredItemsRequest {
  PaginationRequest pagination = 1;
}

// Get expired items response
message GetExpiredItemsResponse {
  repeated ItemDetail item_details = 1;
  PaginationResponse pagination = 2;
  int32 total_expired = 3;
}

// Get items with deposit request
message GetItemsWithDepositRequest {
  PaginationRequest pagination = 1;
}

// Get items with deposit response
message GetItemsWithDepositResponse {
  repeated ItemDetail item_details = 1;
  PaginationResponse pagination = 2;
  double total_deposit_value = 3; // Estimated total deposit value
}

// Get items by location request
message GetItemsByLocationRequest {
  string location_id = 1;
  bool include_children = 2; // Include child locations
  PaginationRequest pagination = 3;
}

// Get items by location response
message GetItemsByLocationResponse {
  repeated ItemDetail item_details = 1;
  PaginationResponse pagination = 2;
}

// ItemDetail service
service ItemDetailService {
  rpc CreateItemDetail(CreateItemDetailRequest) returns (CreateItemDetailResponse);
  rpc BatchCreateItemDetails(BatchCreateItemDetailsRequest) returns (BatchCreateItemDetailsResponse);
  rpc GetItemDetail(IdRequest) returns (GetItemDetailResponse);
  rpc ListItemDetails(ListItemDetailsRequest) returns (ListItemDetailsResponse);
  rpc UpdateItemDetail(UpdateItemDetailRequest) returns (UpdateItemDetailResponse);
  rpc DeleteItemDetail(IdRequest) returns (SuccessResponse);

  // Actions
  rpc OpenItem(OpenItemRequest) returns (OpenItemResponse);
  rpc MoveItems(MoveItemsRequest) returns (MoveItemsResponse);

  // Queries
  rpc GetExpiringItems(GetExpiringItemsRequest) returns (GetExpiringItemsResponse);
  rpc GetExpiredItems(GetExpiredItemsRequest) returns (GetExpiredItemsResponse);
  rpc GetItemsWithDeposit(GetItemsWithDepositRequest) returns (GetItemsWithDepositResponse);
  rpc GetItemsByLocation(GetItemsByLocationRequest) returns (GetItemsByLocationResponse);
}
