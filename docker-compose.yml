version: '3.8'

services:
  # Infrastructure Services

  postgres:
    image: postgres:16-alpine
    container_name: toxictoast-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - toxictoast-network

  redpanda:
    image: redpandadata/redpanda:latest
    container_name: toxictoast-redpanda
    restart: unless-stopped
    command:
      - redpanda
      - start
      - --smp
      - '1'
      - --reserve-memory
      - 0M
      - --overprovisioned
      - --node-id
      - '0'
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:19092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:29092,OUTSIDE://localhost:19092
      - --pandaproxy-addr
      - PLAINTEXT://0.0.0.0:28082,OUTSIDE://0.0.0.0:18082
      - --advertise-pandaproxy-addr
      - PLAINTEXT://redpanda:28082,OUTSIDE://localhost:18082
      - --schema-registry-addr
      - PLAINTEXT://0.0.0.0:8081
    ports:
      - "19092:19092"   # Kafka API (external)
      - "18082:18082"   # HTTP Proxy (external)
      - "8081:8081"     # Schema Registry
      - "9644:9644"     # Admin API
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy'"]
      interval: 15s
      timeout: 10s
      retries: 5
    networks:
      - toxictoast-network

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: toxictoast-keycloak
    restart: unless-stopped
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: postgres
      KC_HOSTNAME: localhost
      KC_HTTP_ENABLED: "true"
    command:
      - start-dev
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - toxictoast-network

  prometheus:
    image: prom/prometheus:latest
    container_name: toxictoast-prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - prometheus_data:/prometheus
    healthcheck:
      test: ["CMD", "wget", "-q", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - toxictoast-network

  grafana:
    image: grafana/grafana:latest
    container_name: toxictoast-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_INSTALL_PLUGINS: ""
    ports:
      - "10009:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "-q", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - toxictoast-network

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: toxictoast-postgres-exporter
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:postgres@postgres:5432/toxictoast?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - toxictoast-network

  alertmanager:
    image: prom/alertmanager:latest
    container_name: toxictoast-alertmanager
    restart: unless-stopped
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
    ports:
      - "9093:9093"
    volumes:
      - alertmanager_data:/alertmanager
    healthcheck:
      test: ["CMD", "wget", "-q", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - toxictoast-network

  # Application Services

  blog-service:
    build:
      context: .
      dockerfile: ./services/blog-service/Dockerfile
    container_name: blog-service
    restart: unless-stopped
    environment:
      PORT: 8080
      GRPC_PORT: 9090
      ENVIRONMENT: docker
      LOG_LEVEL: info
      AUTH_ENABLED: "false"
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: toxictoast
      DB_SSL_MODE: disable
      DB_MAX_OPEN_CONNS: 25
      DB_MAX_IDLE_CONNS: 25
      DB_MAX_LIFETIME: 5m
      KAFKA_BROKERS: redpanda:29092
      KAFKA_GROUP_ID: blog-service
      KAFKA_TOPIC_PREFIX: blog
      MEDIA_UPLOAD_PATH: /app/uploads
      MEDIA_MAX_SIZE: 10485760
      MEDIA_ALLOWED_TYPES: image/jpeg,image/png,image/gif,image/webp
      POST_PUBLISHER_ENABLED: "true"
      POST_PUBLISHER_INTERVAL: 1m
    ports:
      - "10000:8080"
      - "11000:9090"
    volumes:
      - blog_uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:9090"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

  foodfolio-service:
    build:
      context: .
      dockerfile: ./services/foodfolio-service/Dockerfile
    container_name: foodfolio-service
    restart: unless-stopped
    environment:
      PORT: 8080
      GRPC_PORT: 9090
      ENVIRONMENT: docker
      LOG_LEVEL: info
      AUTH_ENABLED: "false"
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: toxictoast
      DB_SSL_MODE: disable
      DB_MAX_OPEN_CONNS: 25
      DB_MAX_IDLE_CONNS: 25
      DB_MAX_LIFETIME: 5m
      KAFKA_BROKERS: redpanda:29092
      KAFKA_GROUP_ID: foodfolio-service
      KAFKA_TOPIC_PREFIX: foodfolio
      OCR_STORAGE_PATH: /app/receipts
      OCR_MAX_SIZE: 10485760
      OCR_ALLOWED_TYPES: image/jpeg,image/png,application/pdf
      OCR_PROVIDER: tesseract
      ITEM_EXPIRATION_ENABLED: "true"
      ITEM_EXPIRATION_INTERVAL: 24h
      STOCK_LEVEL_ENABLED: "true"
      STOCK_LEVEL_INTERVAL: 6h
    ports:
      - "10001:8080"
      - "11001:9090"
    volumes:
      - foodfolio_receipts:/app/receipts
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:9091"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

  link-service:
    build:
      context: .
      dockerfile: ./services/link-service/Dockerfile
    container_name: link-service
    restart: unless-stopped
    environment:
      PORT: 8080
      GRPC_PORT: 9090
      ENVIRONMENT: docker
      LOG_LEVEL: info
      BASE_URL: http://localhost:8080
      AUTH_ENABLED: "false"
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: toxictoast
      DB_SSL_MODE: disable
      DB_MAX_OPEN_CONNS: 25
      DB_MAX_IDLE_CONNS: 25
      DB_MAX_LIFETIME: 5m
      KAFKA_BROKERS: redpanda:29092
      KAFKA_GROUP_ID: link-service
      KAFKA_TOPIC_PREFIX: link
      LINK_EXPIRATION_ENABLED: "true"
      LINK_EXPIRATION_INTERVAL: 1h
    ports:
      - "10002:8080"
      - "11002:9090"
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:9090"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

  notification-service:
    build:
      context: .
      dockerfile: ./services/notification-service/Dockerfile
    container_name: notification-service
    restart: unless-stopped
    environment:
      PORT: 8080
      GRPC_PORT: 9090
      ENVIRONMENT: docker
      LOG_LEVEL: info
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: toxictoast
      DB_SSLMODE: disable
      KAFKA_BROKERS: redpanda:29092
      KAFKA_GROUP_ID: notification-service
      NOTIFICATION_RETRY_ENABLED: "true"
      NOTIFICATION_RETRY_INTERVAL: 5m
      NOTIFICATION_RETRY_MAX_RETRIES: 3
      NOTIFICATION_CLEANUP_ENABLED: "true"
      NOTIFICATION_CLEANUP_INTERVAL: 24h
      NOTIFICATION_CLEANUP_RETENTION_DAYS: 30
    ports:
      - "10003:8080"
      - "11003:9090"
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:9090"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

  sse-service:
    build:
      context: .
      dockerfile: ./services/sse-service/Dockerfile
    container_name: sse-service
    restart: unless-stopped
    environment:
      PORT: 8080
      GRPC_PORT: 9090
      ENVIRONMENT: docker
      LOG_LEVEL: info
      KAFKA_BROKERS: redpanda:29092
      KAFKA_GROUP_ID: sse-service
      KAFKA_CONSUMER_TOPICS: blog.events,foodfolio.events,link.events,notification.events,webhook.events,twitchbot.events
      SSE_HEARTBEAT_SECONDS: 15
      SSE_CLIENT_CLEANUP_ENABLED: "false"
      SSE_CLIENT_CLEANUP_INTERVAL: 10m
      SSE_CLIENT_CLEANUP_INACTIVE_TIMEOUT: 24h
    ports:
      - "10004:8080"
      - "11004:9090"
    depends_on:
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:9090"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

  webhook-service:
    build:
      context: .
      dockerfile: ./services/webhook-service/Dockerfile
    container_name: webhook-service
    restart: unless-stopped
    environment:
      PORT: 8080
      GRPC_PORT: 9090
      ENVIRONMENT: docker
      LOG_LEVEL: info
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: toxictoast
      DB_SSL_MODE: disable
      KAFKA_BROKERS: redpanda:29092
      KAFKA_GROUP_ID: webhook-service
      KAFKA_TOPICS: blog.post.created,blog.post.updated,blog.post.published,foodfolio.detail.expired,link.created,link.clicked
      WEBHOOK_RETRY_ENABLED: "true"
      WEBHOOK_RETRY_INTERVAL: 5m
      WEBHOOK_RETRY_MAX_ATTEMPTS: 5
      WEBHOOK_CLEANUP_ENABLED: "true"
      WEBHOOK_CLEANUP_INTERVAL: 24h
      WEBHOOK_CLEANUP_RETENTION_DAYS: 30
    ports:
      - "10005:8080"
      - "11005:9090"
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:9090"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

  weather-service:
    build:
      context: .
      dockerfile: ./services/weather-service/Dockerfile
    container_name: weather-service
    restart: unless-stopped
    environment:
      PORT: 8080
      GRPC_PORT: 9090
      ENVIRONMENT: docker
      LOG_LEVEL: info
    ports:
      - "10010:8080"
      - "11010:9090"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - toxictoast-network

  twitchbot-service:
    build:
      context: .
      dockerfile: ./services/twitchbot-service/Dockerfile
    container_name: twitchbot-service
    restart: unless-stopped
    environment:
      PORT: 8080
      GRPC_PORT: 9090
      ENVIRONMENT: docker
      LOG_LEVEL: info
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: toxictoast
      DB_SSL_MODE: disable
      KAFKA_BROKERS: redpanda:29092
      KAFKA_GROUP_ID: twitchbot-service
      TWITCH_CHANNEL: toxictoast
      TWITCH_CLIENT_ID: nuqcxagchzgjkpdkx5nc2kzh4ikvoa
      TWITCH_CLIENT_SECRET: eh19j3razt9yonbsn0lm6iojmtp9qu
      TWITCH_ACCESS_TOKEN: 50b7g5umjvkx6xdrvkm0y9hz0ze8p4
      TWITCH_REFRESH_TOKEN: 0fbtzzbud6flak2gmzl7qjzixs9qcyfj6kr31rcqmawa5n8bwi
      TWITCH_BOT_USERNAME: codemechanicus
      TWITCH_IRC_SERVER: irc.chat.twitch.tv
      TWITCH_IRC_PORT: 6667
      MESSAGE_CLEANUP_ENABLED: "true"
      MESSAGE_CLEANUP_INTERVAL: 24h
      MESSAGE_CLEANUP_RETENTION_DAYS: 90
      STREAM_CLOSER_ENABLED: "true"
      STREAM_CLOSER_INTERVAL: 1h
      STREAM_CLOSER_INACTIVE_TIMEOUT: 24h
    ports:
      - "10006:8083"
      - "11006:9093"
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:9093"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

  warcraft-service:
    build:
      context: .
      dockerfile: ./services/warcraft-service/Dockerfile
    container_name: warcraft-service
    restart: unless-stopped
    environment:
      PORT: 9090
      GRPC_PORT: 9090
      ENVIRONMENT: docker
      LOG_LEVEL: info
      BLIZZARD_CLIENT_ID: your_client_id_here
      BLIZZARD_CLIENT_SECRET: your_client_secret_here
      BLIZZARD_REGION: eu
      CACHE_TTL: 3600
    ports:
      - "11007:9090"
    depends_on:
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:9090"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

  auth-service:
    build:
      context: .
      dockerfile: ./services/auth-service/Dockerfile
    container_name: auth-service
    restart: unless-stopped
    environment:
      SERVICE_NAME: auth-service
      PORT: 8080
      GRPC_PORT: 9090
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: toxictoast
      DB_SSLMODE: disable
      JWT_SECRET: your-secret-key-please-change-in-production
      JWT_ACCESS_DURATION: 15m
      JWT_REFRESH_DURATION: 168h
      USER_SERVICE_ADDR: user-service:9090
    ports:
      - "10011:8080"
      - "11011:9090"
    depends_on:
      postgres:
        condition: service_healthy
      user-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:9090"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

  user-service:
    build:
      context: .
      dockerfile: ./services/user-service/Dockerfile
    container_name: user-service
    restart: unless-stopped
    environment:
      SERVICE_NAME: user-service
      PORT: 8080
      GRPC_PORT: 9090
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: toxictoast
      DB_SSLMODE: disable
    ports:
      - "10012:8080"
      - "11012:9090"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:9090"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

  gateway-service:
    build:
      context: .
      dockerfile: ./services/gateway-service/Dockerfile
    container_name: gateway-service
    restart: unless-stopped
    environment:
      HTTP_PORT: 8080
      GRPC_PORT: 9090
      DEV_MODE: "true"
      ENABLE_CORS: "true"
      RATE_LIMIT_RPS: 100
      RATE_LIMIT_BURST: 200
      BLOG_SERVICE_URL: blog-service:9090
      LINK_SERVICE_URL: link-service:9090
      FOODFOLIO_SERVICE_URL: foodfolio-service:9090
      NOTIFICATION_SERVICE_URL: notification-service:9090
      SSE_SERVICE_URL: sse-service:9090
      TWITCHBOT_SERVICE_URL: twitchbot-service:9090
      WEBHOOK_SERVICE_URL: webhook-service:9090
      WARCRAFT_SERVICE_URL: warcraft-service:9090
      WEATHER_SERVICE_URL: weather-service:9090
      AUTH_SERVICE_URL: auth-service:9090
      USER_SERVICE_URL: user-service:9090
      KAFKA_BROKERS: redpanda:29092
    ports:
      - "10008:8080"
      - "11008:9090"
    depends_on:
      - blog-service
      - foodfolio-service
      - link-service
      - notification-service
      - sse-service
      - webhook-service
      - twitchbot-service
      - warcraft-service
      - weather-service
      - auth-service
      - user-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - toxictoast-network

volumes:
  postgres_data:
    driver: local
  redpanda_data:
    driver: local
  blog_uploads:
    driver: local
  foodfolio_receipts:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  alertmanager_data:
    driver: local

networks:
  toxictoast-network:
    driver: bridge
